-- ============================================================================
-- SCRIPT DE CRIAÇÃO DO SCHEMA INICIAL - WELLMIND API
-- Database: Oracle 12c+
-- ============================================================================

-- Sequence para IDs (Oracle não tem IDENTITY automático em versões antigas)
CREATE SEQUENCE SEQ_USUARIO START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_EMPRESA START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_REGISTRO_BEMESTAR START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_ALERTA START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_RECOMENDACAO START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_SESSAO START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_TRANSICAO_CARREIRA START WITH 1 INCREMENT BY 1;

-- ============================================================================
-- TABELA: USUARIO
-- ============================================================================
CREATE TABLE USUARIO (
    ID_USUARIO NUMBER(10) PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100) NOT NULL UNIQUE,
    SENHA_HASH VARCHAR2(255) NOT NULL,
    DATA_NASCIMENTO DATE NOT NULL,
    GENERO VARCHAR2(20),
    TELEFONE VARCHAR2(20),
    DATA_CADASTRO DATE DEFAULT SYSDATE NOT NULL,
    STATUS_ATIVO CHAR(1) DEFAULT 'S' CHECK (STATUS_ATIVO IN ('S', 'N'))
);

CREATE INDEX IX_USUARIO_EMAIL ON USUARIO(EMAIL);

-- Trigger para auto-incremento
CREATE OR REPLACE TRIGGER TRG_USUARIO_ID
BEFORE INSERT ON USUARIO
FOR EACH ROW
BEGIN
    IF :NEW.ID_USUARIO IS NULL THEN
        SELECT SEQ_USUARIO.NEXTVAL INTO :NEW.ID_USUARIO FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: EMPRESA
-- ============================================================================
CREATE TABLE EMPRESA (
    ID_EMPRESA NUMBER(10) PRIMARY KEY,
    NOME_EMPRESA VARCHAR2(200) NOT NULL,
    CNPJ VARCHAR2(14) NOT NULL UNIQUE,
    ENDERECO VARCHAR2(300),
    TELEFONE VARCHAR2(20),
    EMAIL_CONTATO VARCHAR2(100),
    DATA_CADASTRO DATE DEFAULT SYSDATE NOT NULL
);

CREATE INDEX IX_EMPRESA_CNPJ ON EMPRESA(CNPJ);

CREATE OR REPLACE TRIGGER TRG_EMPRESA_ID
BEFORE INSERT ON EMPRESA
FOR EACH ROW
BEGIN
    IF :NEW.ID_EMPRESA IS NULL THEN
        SELECT SEQ_EMPRESA.NEXTVAL INTO :NEW.ID_EMPRESA FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: REGISTRO_BEMESTAR
-- ============================================================================
CREATE TABLE REGISTRO_BEMESTAR (
    ID_REGISTRO NUMBER(10) PRIMARY KEY,
    ID_USUARIO NUMBER(10) NOT NULL,
    DATA_REGISTRO DATE DEFAULT SYSDATE NOT NULL,
    NIVEL_HUMOR NUMBER(2) NOT NULL CHECK (NIVEL_HUMOR BETWEEN 1 AND 10),
    NIVEL_ESTRESSE NUMBER(2) NOT NULL CHECK (NIVEL_ESTRESSE BETWEEN 1 AND 10),
    NIVEL_ENERGIA NUMBER(2) NOT NULL CHECK (NIVEL_ENERGIA BETWEEN 1 AND 10),
    HORAS_SONO NUMBER(4,2) NOT NULL CHECK (HORAS_SONO BETWEEN 0 AND 24),
    QUALIDADE_SONO NUMBER(2) NOT NULL CHECK (QUALIDADE_SONO BETWEEN 1 AND 10),
    OBSERVACOES VARCHAR2(500),
    CONSTRAINT FK_REGISTRO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE INDEX IX_REGISTRO_USUARIO_DATA ON REGISTRO_BEMESTAR(ID_USUARIO, DATA_REGISTRO);

CREATE OR REPLACE TRIGGER TRG_REGISTRO_ID
BEFORE INSERT ON REGISTRO_BEMESTAR
FOR EACH ROW
BEGIN
    IF :NEW.ID_REGISTRO IS NULL THEN
        SELECT SEQ_REGISTRO_BEMESTAR.NEXTVAL INTO :NEW.ID_REGISTRO FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: ALERTA
-- ============================================================================
CREATE TABLE ALERTA (
    ID_ALERTA NUMBER(10) PRIMARY KEY,
    ID_USUARIO NUMBER(10) NOT NULL,
    TIPO_ALERTA VARCHAR2(50) NOT NULL,
    DESCRICAO VARCHAR2(500),
    NIVEL_GRAVIDADE VARCHAR2(20) NOT NULL CHECK (NIVEL_GRAVIDADE IN ('BAIXO', 'MEDIO', 'ALTO', 'CRITICO')),
    STATUS_ALERTA VARCHAR2(20) DEFAULT 'PENDENTE' CHECK (STATUS_ALERTA IN ('PENDENTE', 'EM_ANALISE', 'RESOLVIDO', 'CANCELADO')),
    DATA_ALERTA DATE DEFAULT SYSDATE NOT NULL,
    DATA_RESOLUCAO DATE,
    ACAO_TOMADA VARCHAR2(500),
    CONSTRAINT FK_ALERTA_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE INDEX IX_ALERTA_STATUS ON ALERTA(STATUS_ALERTA);
CREATE INDEX IX_ALERTA_GRAVIDADE ON ALERTA(NIVEL_GRAVIDADE);
CREATE INDEX IX_ALERTA_USUARIO_STATUS ON ALERTA(ID_USUARIO, STATUS_ALERTA);

CREATE OR REPLACE TRIGGER TRG_ALERTA_ID
BEFORE INSERT ON ALERTA
FOR EACH ROW
BEGIN
    IF :NEW.ID_ALERTA IS NULL THEN
        SELECT SEQ_ALERTA.NEXTVAL INTO :NEW.ID_ALERTA FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: RECOMENDACAO
-- ============================================================================
CREATE TABLE RECOMENDACAO (
    ID_RECOMENDACAO NUMBER(10) PRIMARY KEY,
    ID_USUARIO NUMBER(10) NOT NULL,
    DATA_RECOMENDACAO DATE DEFAULT SYSDATE NOT NULL,
    TIPO_RECOMENDACAO VARCHAR2(50) NOT NULL,
    CONTEUDO VARCHAR2(1000) NOT NULL,
    LINK VARCHAR2(500),
    LIDA CHAR(1) DEFAULT 'N' CHECK (LIDA IN ('S', 'N')),
    CONSTRAINT FK_RECOMENDACAO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE INDEX IX_RECOMENDACAO_USUARIO_LIDA ON RECOMENDACAO(ID_USUARIO, LIDA);

CREATE OR REPLACE TRIGGER TRG_RECOMENDACAO_ID
BEFORE INSERT ON RECOMENDACAO
FOR EACH ROW
BEGIN
    IF :NEW.ID_RECOMENDACAO IS NULL THEN
        SELECT SEQ_RECOMENDACAO.NEXTVAL INTO :NEW.ID_RECOMENDACAO FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: SESSAO
-- ============================================================================
CREATE TABLE SESSAO (
    ID_SESSAO NUMBER(10) PRIMARY KEY,
    ID_USUARIO NUMBER(10) NOT NULL,
    DATA_SESSAO DATE NOT NULL,
    TIPO_SESSAO VARCHAR2(50) NOT NULL,
    TEMA VARCHAR2(200),
    OBSERVACOES VARCHAR2(1000),
    PROXIMOS_PASSOS VARCHAR2(500),
    CONSTRAINT FK_SESSAO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE INDEX IX_SESSAO_USUARIO_DATA ON SESSAO(ID_USUARIO, DATA_SESSAO);

CREATE OR REPLACE TRIGGER TRG_SESSAO_ID
BEFORE INSERT ON SESSAO
FOR EACH ROW
BEGIN
    IF :NEW.ID_SESSAO IS NULL THEN
        SELECT SEQ_SESSAO.NEXTVAL INTO :NEW.ID_SESSAO FROM DUAL;
    END IF;
END;
/

-- ============================================================================
-- TABELA: TRANSICAO_CARREIRA
-- ============================================================================
CREATE TABLE TRANSICAO_CARREIRA (
    ID_TRANSICAO NUMBER(10) PRIMARY KEY,
    ID_USUARIO NUMBER(10) NOT NULL,
    DATA_TRANSICAO DATE DEFAULT SYSDATE NOT NULL,
    TIPO_TRANSICAO VARCHAR2(50) NOT NULL,
    CARGO_ANTERIOR VARCHAR2(100),
    CARGO_NOVO VARCHAR2(100),
    DESCRICAO VARCHAR2(500),
    STATUS_TRANSICAO VARCHAR2(20) DEFAULT 'EM_ANDAMENTO' CHECK (STATUS_TRANSICAO IN ('EM_ANDAMENTO', 'CONCLUIDA', 'CANCELADA')),
    CONSTRAINT FK_TRANSICAO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE INDEX IX_TRANSICAO_USUARIO_STATUS ON TRANSICAO_CARREIRA(ID_USUARIO, STATUS_TRANSICAO);

CREATE OR REPLACE TRIGGER TRG_TRANSICAO_ID
BEFORE INSERT ON TRANSICAO_CARREIRA
FOR EACH ROW
BEGIN
    IF :NEW.ID_TRANSICAO IS NULL THEN
        SELECT SEQ_TRANSICAO_CARREIRA.NEXTVAL INTO :NEW.ID_TRANSICAO FROM DUAL;
    END IF;
END;
/

COMMIT;
